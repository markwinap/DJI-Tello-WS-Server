!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.JMuxer=t()}(this,function(){"use strict";function e(){a=console.log,s=console.error}function t(e){if(a){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];a.apply(void 0,[e].concat(r))}}function r(e){if(s){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];s.apply(void 0,[e].concat(r))}}function n(e,t){var r=new Uint8Array((0|e.byteLength)+(0|t.byteLength));return r.set(e,0),r.set(t,0|e.byteLength),r}function i(e){var t=void 0,r=void 0,n=void 0,i="";return t=Math.floor(e),r=parseInt(t/3600,10)%24,n=parseInt(t/60,10)%60,t=t<0?0:t%60,r>0&&(i+=(r<10?"0"+r:r)+":"),i+=(n<10?"0"+n:n)+":"+(t<10?"0"+t:t)}var a=void 0,s=void 0,o=(function(){function e(e){this.value=e}function t(t){function r(e,t){return new Promise(function(r,i){var o={key:e,arg:t,resolve:r,reject:i,next:null};s?s=s.next=o:(a=s=o,n(e,t))})}function n(r,a){try{var s=t[r](a),o=s.value;o instanceof e?Promise.resolve(o.value).then(function(e){n("next",e)},function(e){n("throw",e)}):i(s.done?"return":"normal",s.value)}catch(e){i("throw",e)}}function i(e,t){switch(e){case"return":a.resolve({value:t,done:!0});break;case"throw":a.reject(t);break;default:a.resolve({value:t,done:!1})}a=a.next,a?n(a.key,a.arg):s=null}var a,s;this._invoke=r,"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},f=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},c=function(){function e(t){o(this,e),this.payload=t,this.nri=(96&this.payload[0])>>5,this.ntype=31&this.payload[0]}return u(e,null,[{key:"type",value:function(t){return t.ntype in e.TYPES?e.TYPES[t.ntype]:"UNKNOWN"}},{key:"NDR",get:function(){return 1}},{key:"IDR",get:function(){return 5}},{key:"SEI",get:function(){return 6}},{key:"SPS",get:function(){return 7}},{key:"PPS",get:function(){return 8}},{key:"AUD",get:function(){return 9}},{key:"TYPES",get:function(){var t;return t={},babelHelpers.defineProperty(t,e.IDR,"IDR"),babelHelpers.defineProperty(t,e.SEI,"SEI"),babelHelpers.defineProperty(t,e.SPS,"SPS"),babelHelpers.defineProperty(t,e.PPS,"PPS"),babelHelpers.defineProperty(t,e.NDR,"NDR"),babelHelpers.defineProperty(t,e.AUD,"AUD"),t}}]),u(e,[{key:"toString",value:function(){return e.type(this)+": NRI: "+this.getNri()}},{key:"getNri",value:function(){return this.nri>>6}},{key:"type",value:function(){return this.ntype}},{key:"isKeyframe",value:function(){return this.ntype==e.IDR}},{key:"getSize",value:function(){return 4+this.payload.byteLength}},{key:"getData",value:function(){var e=new Uint8Array(this.getSize());return new DataView(e.buffer).setUint32(0,this.getSize()-4),e.set(this.payload,4),e}}]),e}(),d=function(){function e(t){o(this,e),this.data=t,this.index=0,this.bitLength=8*t.byteLength}return u(e,[{key:"skipBits",value:function(e){if(this.bitsAvailable<e)return!1;this.index+=e}},{key:"readBits",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.getBits(e,this.index,t)}},{key:"getBits",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this.bitsAvailable<e)return 0;var n=t%8,i=this.data[t/8|0]&255>>>n,a=8-n;if(a>=e)return r&&(this.index+=e),i>>a-e;r&&(this.index+=a);var s=e-a;return i<<s|this.getBits(s,t+a,r)}},{key:"skipLZ",value:function(){var e=void 0;for(e=0;e<this.bitLength-this.index;++e)if(0!==this.getBits(1,this.index+e,!1))return this.index+=e,e;return e}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"skipEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var e=this.skipLZ();return this.readBits(e+1)-1}},{key:"readEG",value:function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}},{key:"readBoolean",value:function(){return 1===this.readBits(1)}},{key:"readUByte",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.readBits(8*e)}},{key:"readUShort",value:function(){return this.readBits(16)}},{key:"readUInt",value:function(){return this.readBits(32)}},{key:"bitsAvailable",get:function(){return this.bitLength-this.index}}]),e}(),h=function(){function e(t){o(this,e),this.remuxer=t,this.track=t.mp4track}return u(e,null,[{key:"extractNALu",value:function(e){for(var t=0,r=e.byteLength,n=void 0,i=0,a=[],s=void 0;t<r;)switch(n=e[t++],i){case 0:0===n&&(i=1);break;case 1:i=0===n?2:0;break;case 2:case 3:0===n?i=3:1===n&&t<r?(s&&a.push(e.subarray(s,t-i-1)),s=t,i=0):i=0}return s&&a.push(e.subarray(s,r)),a}},{key:"skipScalingList",value:function(e,t){for(var r=8,n=8,i=void 0,a=0;a<t;a++)0!==n&&(i=e.readEG(),n=(r+i+256)%256),r=0===n?r:n}},{key:"readSPS",value:function(t){var r=new d(t),n=0,i=0,a=0,s=0,o=1,u=void 0,l=void 0,f=void 0,c=void 0,h=void 0,y=void 0;if(r.readUByte(),u=r.readUByte(),r.readBits(5),r.skipBits(3),r.readUByte(),r.skipUEG(),100===u||110===u||122===u||244===u||44===u||83===u||86===u||118===u||128===u){var p=r.readUEG();if(3===p&&r.skipBits(1),r.skipUEG(),r.skipUEG(),r.skipBits(1),r.readBoolean()){y=3!==p?8:12;for(var v=0;v<y;++v)r.readBoolean()&&(v<6?e.skipScalingList(r,16):e.skipScalingList(r,64))}}r.skipUEG();var k=r.readUEG();if(0===k)r.readUEG();else if(1===k){r.skipBits(1),r.skipEG(),r.skipEG(),l=r.readUEG();for(var m=0;m<l;++m)r.skipEG()}if(r.skipUEG(),r.skipBits(1),f=r.readUEG(),c=r.readUEG(),h=r.readBits(1),0===h&&r.skipBits(1),r.skipBits(1),r.readBoolean()&&(n=r.readUEG(),i=r.readUEG(),a=r.readUEG(),s=r.readUEG()),r.readBoolean()){if(r.readBoolean()){var b=void 0;switch(r.readUByte()){case 1:b=[1,1];break;case 2:b=[12,11];break;case 3:b=[10,11];break;case 4:b=[16,11];break;case 5:b=[40,33];break;case 6:b=[24,11];break;case 7:b=[20,11];break;case 8:b=[32,11];break;case 9:b=[80,33];break;case 10:b=[18,11];break;case 11:b=[15,11];break;case 12:b=[64,33];break;case 13:b=[160,99];break;case 14:b=[4,3];break;case 15:b=[3,2];break;case 16:b=[2,1];break;case 255:b=[r.readUByte()<<8|r.readUByte(),r.readUByte()<<8|r.readUByte()]}b&&(o=b[0]/b[1])}if(r.readBoolean()&&r.skipBits(1),r.readBoolean()&&(r.skipBits(4),r.readBoolean()&&r.skipBits(24)),r.readBoolean()&&(r.skipUEG(),r.skipUEG()),r.readBoolean()){r.readUInt(),r.readUInt(),r.readBoolean()}}return{width:Math.ceil((16*(f+1)-2*n-2*i)*o),height:(2-h)*(c+1)*16-(h?2:4)*(a+s)}}}]),u(e,[{key:"parseSPS",value:function(t){var r=e.readSPS(new Uint8Array(t));this.track.width=r.width,this.track.height=r.height,this.track.sps=[new Uint8Array(t)],this.track.codec="avc1.";for(var n=new DataView(t.buffer,t.byteOffset+1,4),i=0;i<3;++i){var a=n.getUint8(i).toString(16);a.length<2&&(a="0"+a),this.track.codec+=a}}},{key:"parsePPS",value:function(e){this.track.pps=[new Uint8Array(e)]}},{key:"parseNAL",value:function(e){if(!e)return!1;var r=!1;switch(e.type()){case c.NDR:case c.IDR:r=!0;break;case c.PPS:this.track.pps||(this.parsePPS(e.getData().subarray(4)),!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0)),r=!0;break;case c.SPS:this.track.sps||(this.parseSPS(e.getData().subarray(4)),!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0)),r=!0;break;case c.AUD:t("AUD - ignoing and disable HD mode for live channel"),this.remuxer.isHDAvail&&(this.remuxer.isHDAvail=!1);break;case c.SEI:t("SEI - ignoing")}return r}}]),e}(),y=void 0,p=function(){function e(t){o(this,e),this.remuxer=t,this.track=t.mp4track}return u(e,null,[{key:"getHeaderLength",value:function(e){return 1&e[1]?7:9}},{key:"getFrameLength",value:function(e){return(3&e[3])<<11|e[4]<<3|(224&e[5])>>>5}},{key:"isAACPattern",value:function(e){return 255===e[0]&&240==(240&e[1])&&0==(6&e[1])}},{key:"extractAAC",value:function(t){var n=0,i=t.byteLength,a=[],s=void 0,o=void 0;if(!e.isAACPattern(t))return r("Invalid ADTS audio format"),a;for(s=e.getHeaderLength(t),y||(y=t.subarray(0,s));n<i;)o=e.getFrameLength(t),a.push(t.subarray(s,o)),t=t.slice(o),n+=o;return a}},{key:"samplingRateMap",get:function(){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]}},{key:"getAACHeaderData",get:function(){return y}}]),u(e,[{key:"setAACConfig",value:function(){var t=void 0,r=void 0,n=void 0,i=new Uint8Array(2),a=e.getAACHeaderData;a&&(t=1+((192&a[2])>>>6),r=(60&a[2])>>>2,n=(1&a[2])<<2,n|=(192&a[3])>>>6,i[0]=t<<3,i[0]|=(14&r)>>1,i[1]|=(1&r)<<7,i[1]|=n<<3,this.track.codec="mp4a.40."+t,this.track.channelCount=n,this.track.config=i,this.remuxer.readyToDecode=!0)}}]),e}(),v=function(){function e(t){o(this,e),this.listener={},this.type=""|t}return u(e,[{key:"on",value:function(e,t){return this.listener[e]||(this.listener[e]=[]),this.listener[e].push(t),!0}},{key:"off",value:function(e,t){if(this.listener[e]){var r=this.listener[e].indexOf(t);return r>-1&&this.listener[e].splice(r,1),!0}return!1}},{key:"offAll",value:function(){this.listener={}}},{key:"dispatch",value:function(e,t){return!!this.listener[e]&&(this.listener[e].map(function(e){e.apply(null,[t])}),!0)}}]),e}(),k=function(){function e(){o(this,e)}return u(e,null,[{key:"init",value:function(){e.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var t;for(t in e.types)e.types.hasOwnProperty(t)&&(e.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);var r=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),n=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);e.HDLR_TYPES={video:r,audio:n};var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),a=new Uint8Array([0,0,0,0,0,0,0,0]);e.STTS=e.STSC=e.STCO=a,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var s=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),u=new Uint8Array([0,0,0,1]);e.FTYP=e.box(e.types.ftyp,s,u,s,o),e.DINF=e.box(e.types.dinf,e.box(e.types.dref,i))}},{key:"box",value:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];for(var i,a=8,s=r.length,o=s;s--;)a+=r[s].byteLength;for(i=new Uint8Array(a),i[0]=a>>24&255,i[1]=a>>16&255,i[2]=a>>8&255,i[3]=255&a,i.set(e,4),s=0,a=8;s<o;++s)i.set(r[s],a),a+=r[s].byteLength;return i}},{key:"hdlr",value:function(t){return e.box(e.types.hdlr,e.HDLR_TYPES[t])}},{key:"mdat",value:function(t){return e.box(e.types.mdat,t)}},{key:"mdhd",value:function(t,r){return e.box(e.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}},{key:"mdia",value:function(t){return e.box(e.types.mdia,e.mdhd(t.timescale,t.duration),e.hdlr(t.type),e.minf(t))}},{key:"mfhd",value:function(t){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}},{key:"minf",value:function(t){return"audio"===t.type?e.box(e.types.minf,e.box(e.types.smhd,e.SMHD),e.DINF,e.stbl(t)):e.box(e.types.minf,e.box(e.types.vmhd,e.VMHD),e.DINF,e.stbl(t))}},{key:"moof",value:function(t,r,n){return e.box(e.types.moof,e.mfhd(t),e.traf(n,r))}},{key:"moov",value:function(t,r,n){for(var i=t.length,a=[];i--;)a[i]=e.trak(t[i]);return e.box.apply(null,[e.types.moov,e.mvhd(n,r)].concat(a).concat(e.mvex(t)))}},{key:"mvex",value:function(t){for(var r=t.length,n=[];r--;)n[r]=e.trex(t[r]);return e.box.apply(null,[e.types.mvex].concat(n))}},{key:"mvhd",value:function(t,r){var n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24&255,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.box(e.types.mvhd,n)}},{key:"sdtp",value:function(t){var r,n,i=t.samples||[],a=new Uint8Array(4+i.length);for(n=0;n<i.length;n++)r=i[n].flags,a[n+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return e.box(e.types.sdtp,a)}},{key:"stbl",value:function(t){return e.box(e.types.stbl,e.stsd(t),e.box(e.types.stts,e.STTS),e.box(e.types.stsc,e.STSC),e.box(e.types.stsz,e.STSZ),e.box(e.types.stco,e.STCO))}},{key:"avc1",value:function(t){var r,n,i,a=[],s=[];for(r=0;r<t.sps.length;r++)n=t.sps[r],i=n.byteLength,a.push(i>>>8&255),a.push(255&i),a=a.concat(Array.prototype.slice.call(n));for(r=0;r<t.pps.length;r++)n=t.pps[r],i=n.byteLength,s.push(i>>>8&255),s.push(255&i),s=s.concat(Array.prototype.slice.call(n));var o=e.box(e.types.avcC,new Uint8Array([1,a[3],a[4],a[5],255,224|t.sps.length].concat(a).concat([t.pps.length]).concat(s))),u=t.width,l=t.height;return e.box(e.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,255&u,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,108,112,114,111,46,114,117,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,e.box(e.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))}},{key:"esds",value:function(e){var t=e.config.byteLength,r=new Uint8Array(26+t+3);return r.set([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5,t]),r.set(e.config,26),r.set([6,1,2],26+t),r}},{key:"mp4a",value:function(t){var r=t.audiosamplerate;return e.box(e.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,r>>8&255,255&r,0,0]),e.box(e.types.esds,e.esds(t)))}},{key:"stsd",value:function(t){return"audio"===t.type?e.box(e.types.stsd,e.STSD,e.mp4a(t)):e.box(e.types.stsd,e.STSD,e.avc1(t))}},{key:"tkhd",value:function(t){var r=t.id,n=t.duration,i=t.width,a=t.height,s=t.volume;return e.box(e.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,r>>24&255,r>>16&255,r>>8&255,255&r,0,0,0,0,n>>24,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,s>>0&255,s%1*10>>0&255,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,255&i,0,0,a>>8&255,255&a,0,0]))}},{key:"traf",value:function(t,r){var n=e.sdtp(t),i=t.id;return e.box(e.types.traf,e.box(e.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i])),e.box(e.types.tfdt,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),e.trun(t,n.length+16+16+8+16+8+8),n)}},{key:"trak",value:function(t){return t.duration=t.duration||4294967295,e.box(e.types.trak,e.tkhd(t),e.mdia(t))}},{key:"trex",value:function(t){var r=t.id;return e.box(e.types.trex,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trun",value:function(t,r){var n,i,a,s,o,u,l=t.samples||[],f=l.length,c=12+16*f,d=new Uint8Array(c);for(r+=8+c,d.set([0,0,15,1,f>>>24&255,f>>>16&255,f>>>8&255,255&f,r>>>24&255,r>>>16&255,r>>>8&255,255&r],0),n=0;n<f;n++)i=l[n],a=i.duration,s=i.size,o=i.flags,u=i.cts,d.set([a>>>24&255,a>>>16&255,a>>>8&255,255&a,s>>>24&255,s>>>16&255,s>>>8&255,255&s,o.isLeading<<2|o.dependsOn,o.isDependedOn<<6|o.hasRedundancy<<4|o.paddingValue<<1|o.isNonSync,61440&o.degradPrio,15&o.degradPrio,u>>>24&255,u>>>16&255,u>>>8&255,255&u],12+16*n);return e.box(e.types.trun,d)}},{key:"initSegment",value:function(t,r,n){e.types||e.init();var i,a=e.moov(t,r,n);return i=new Uint8Array(e.FTYP.byteLength+a.byteLength),i.set(e.FTYP),i.set(a,e.FTYP.byteLength),i}}]),e}(),m=1,b=function(){function e(){o(this,e),this.seq=1}return u(e,null,[{key:"getTrackID",value:function(){return m++}}]),u(e,[{key:"flush",value:function(){this.seq++,this.mp4track.len=0,this.mp4track.samples=[]}},{key:"isReady",value:function(){return!(!this.readyToDecode||!this.samples.length)||null}}]),e}(),g=function(e){function r(){o(this,r);var e=f(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return e.readyToDecode=!1,e.nextDts=0,e.dts=0,e.timescale=1e3,e.mp4track={id:b.getTrackID(),type:"audio",channelCount:0,len:0,fragmented:!0,timescale:e.timescale,duration:e.timescale,samples:[],config:"",codec:""},e.samples=[],e.aac=new p(e),e}return l(r,e),u(r,[{key:"resetTrack",value:function(){this.readyToDecode=!1,this.mp4track.codec="",this.mp4track.channelCount="",this.mp4track.config="",this.mp4track.timescale=this.timescale}},{key:"remux",value:function(e){var t=void 0,r=void 0,n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var u=s.value;r=u.units,t=r.byteLength,this.samples.push({units:r,size:t,duration:u.duration}),this.mp4track.len+=t,this.readyToDecode||this.aac.setAACConfig()}}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}}},{key:"getPayload",value:function(){if(!this.isReady())return null;var e=new Uint8Array(this.mp4track.len),r=0,n=this.mp4track.samples,i=void 0,a=void 0;for(this.dts=this.nextDts;this.samples.length;){var s=this.samples.shift();a=s.duration,a<=0?(t("remuxer: invalid sample duration at DTS: "+this.nextDts+" :"+a),this.mp4track.len-=s.size):(this.nextDts+=a,i={size:s.size,duration:a,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},e.set(s.units,r),r+=s.size,n.push(i))}return n.length?new Uint8Array(e.buffer,0,this.mp4track.len):null}}]),r}(b),S=function(e){function r(){o(this,r);var e=f(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return e.readyToDecode=!1,e.nextDts=0,e.dts=0,e.timescale=1e3,e.mp4track={id:b.getTrackID(),type:"video",len:0,fragmented:!0,sps:"",pps:"",width:0,height:0,timescale:e.timescale,duration:e.timescale,samples:[]},e.samples=[],e.h264=new h(e),e}return l(r,e),u(r,[{key:"resetTrack",value:function(){this.readyToDecode=!1,this.mp4track.sps="",this.mp4track.pps=""}},{key:"remux",value:function(e){var t=void 0,r=void 0,n=void 0,i=void 0,a=void 0,s=!0,o=!1,u=void 0;try{for(var l,f=e[Symbol.iterator]();!(s=(l=f.next()).done);s=!0){t=l.value,r=[],i=0,a=!1;var c=!0,d=!1,h=void 0;try{for(var y,p=t.units[Symbol.iterator]();!(c=(y=p.next()).done);c=!0)n=y.value,this.h264.parseNAL(n)&&(r.push(n),i+=n.getSize(),a||(a=n.isKeyframe()))}catch(e){d=!0,h=e}finally{try{!c&&p.return&&p.return()}finally{if(d)throw h}}r.length>0&&this.readyToDecode&&(this.mp4track.len+=i,this.samples.push({units:r,size:i,keyFrame:a,duration:t.duration}))}}catch(e){o=!0,u=e}finally{try{!s&&f.return&&f.return()}finally{if(o)throw u}}}},{key:"getPayload",value:function(){if(!this.isReady())return null;var e=new Uint8Array(this.mp4track.len),r=0,n=this.mp4track.samples,i=void 0,a=void 0;for(this.dts=this.nextDts;this.samples.length;){var s=this.samples.shift(),o=s.units;if((a=s.duration)<=0)t("remuxer: invalid sample duration at DTS: "+this.nextDts+" :"+a),this.mp4track.len-=s.size;else{this.nextDts+=a,i={size:s.size,duration:a,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,isNonSync:s.keyFrame?0:1,dependsOn:s.keyFrame?2:1}};var u=!0,l=!1,f=void 0;try{for(var c,d=o[Symbol.iterator]();!(u=(c=d.next()).done);u=!0){var h=c.value;e.set(h.getData(),r),r+=h.getSize()}}catch(e){l=!0,f=e}finally{try{!u&&d.return&&d.return()}finally{if(l)throw f}}n.push(i)}}return n.length?new Uint8Array(e.buffer,0,this.mp4track.len):null}}]),r}(b),x=function(e){function r(e){o(this,r);var t=f(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,"remuxer"));return t.initialized=!1,t.trackTypes=[],t.tracks={},t.mediaDuration=e?1/0:1e3,t}return l(r,e),u(r,[{key:"addTrack",value:function(e){"video"!==e&&"both"!==e||(this.tracks.video=new S,this.trackTypes.push("video")),"audio"!==e&&"both"!==e||(this.tracks.audio=new g,this.trackTypes.push("audio"))}},{key:"reset",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this.trackTypes[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;this.tracks[a].resetTrack()}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}this.initialized=!1}},{key:"destroy",value:function(){this.tracks={},this.offAll()}},{key:"flush",value:function(){if(this.initialized){var e=!0,r=!1,a=void 0;try{for(var s,o=this.trackTypes[Symbol.iterator]();!(e=(s=o.next()).done);e=!0){var u=s.value,l=this.tracks[u],f=l.getPayload();if(f&&f.byteLength){var c=k.moof(l.seq,l.dts,l.mp4track),d=k.mdat(f),h=n(c,d),y={type:u,payload:h,dts:l.dts};this.dispatch("buffer",y);var p=i(l.dts/1e3);t("put segment ("+u+"): "+l.seq+" dts: "+l.dts+" samples: "+l.mp4track.samples.length+" second: "+p),l.flush()}}}catch(e){r=!0,a=e}finally{try{!e&&o.return&&o.return()}finally{if(r)throw a}}}else if(this.isReady()){this.dispatch("ready");var v=!0,m=!1,b=void 0;try{for(var g,S=this.trackTypes[Symbol.iterator]();!(v=(g=S.next()).done);v=!0){var x=g.value,w=this.tracks[x],B={type:x,payload:k.initSegment([w.mp4track],this.mediaDuration,w.mp4track.timescale)};this.dispatch("buffer",B)}}catch(e){m=!0,b=e}finally{try{!v&&S.return&&S.return()}finally{if(m)throw b}}t("Initial segment generated."),this.initialized=!0}}},{key:"isReady",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this.trackTypes[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;if(!this.tracks[a].readyToDecode||!this.tracks[a].samples.length)return!1}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}return!0}},{key:"remux",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this.trackTypes[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var s=i.value,o=e[s];"audio"===s&&this.tracks.video&&!this.tracks.video.readyToDecode||o.length>0&&this.tracks[s].remux(o)}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}this.flush()}}]),r}(v),w=function(e){function i(e,t){o(this,i);var r=f(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,"buffer"));return r.type=t,r.queue=new Uint8Array,r.cleaning=!1,r.pendingCleaning=0,r.cleanOffset=30,r.cleanRanges=[],r.sourceBuffer=e,r.sourceBuffer.addEventListener("updateend",function(){if(r.pendingCleaning>0&&(r.initCleanup(r.pendingCleaning),r.pendingCleaning=0),r.cleaning=!1,r.cleanRanges.length)return void r.doCleanup()}),r.sourceBuffer.addEventListener("error",function(){r.dispatch("error",{type:r.type,name:"buffer",error:"buffer error"})}),r}return l(i,e),u(i,[{key:"destroy",value:function(){this.queue=null,this.sourceBuffer=null,this.offAll()}},{key:"doCleanup",value:function(){if(!this.cleanRanges.length)return void(this.cleaning=!1);var e=this.cleanRanges.shift();t(this.type+" remove range ["+e[0]+" - "+e[1]+")"),this.cleaning=!0,this.sourceBuffer.remove(e[0],e[1])}},{key:"initCleanup",value:function(e){if(this.sourceBuffer.updating)return void(this.pendingCleaning=e);if(this.sourceBuffer.buffered&&this.sourceBuffer.buffered.length&&!this.cleaning){for(var t=0;t<this.sourceBuffer.buffered.length;++t){var r=this.sourceBuffer.buffered.start(t),n=this.sourceBuffer.buffered.end(t);e-r>this.cleanOffset&&(n=e-this.cleanOffset,r<n&&this.cleanRanges.push([r,n]))}this.doCleanup()}}},{key:"doAppend",value:function(){if(this.queue.length&&!this.sourceBuffer.updating)try{this.sourceBuffer.appendBuffer(this.queue),this.queue=new Uint8Array}catch(e){if("QuotaExceededError"===e.name)return t(this.type+" buffer quota full"),void this.dispatch("error",{type:this.type,name:"QuotaExceeded",error:"buffer error"});r("Error occured while appending "+this.type+" buffer -  "+e.name+": "+e.message),this.dispatch("error",{type:this.type,name:"unexpectedError",error:"buffer error"})}}},{key:"feed",value:function(e){this.queue=n(this.queue,e)}}]),i}(v);return window.MediaSource=window.MediaSource||window.WebKitMediaSource,function(t){function n(t){o(this,n);var i=f(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"jmuxer"));window.MediaSource=window.MediaSource||window.WebKitMediaSource;var a={node:"",mode:"both",flushingTime:1500,clearBuffer:!0,onReady:null,fps:30,debug:!1};if(i.options=Object.assign({},a,t),i.options.debug&&e(),"string"==typeof i.options.node&&""==i.options.node&&r("no video element were found to render, provide a valid video element"),i.options.fps||(i.options.fps=30),i.frameDuration=1e3/i.options.fps|0,i.node="string"==typeof i.options.node?document.getElementById(i.options.node):i.options.node,i.sourceBuffers={},i.isMSESupported=!!window.MediaSource,!i.isMSESupported)throw"Oops! Browser does not support media source extension.";return i.setupMSE(),i.remuxController=new x(i.options.clearBuffer),i.remuxController.addTrack(i.options.mode),i.mseReady=!1,i.lastCleaningTime=Date.now(),i.keyframeCache=[],i.frameCounter=0,i.remuxController.on("buffer",i.onBuffer.bind(i)),i.remuxController.on("ready",i.createBuffer.bind(i)),i.startInterval(),i}return l(n,t),u(n,null,[{key:"isSupported",value:function(e){return window.MediaSource&&window.MediaSource.isTypeSupported(e)}}]),u(n,[{key:"setupMSE",value:function(){this.mediaSource=new MediaSource,this.node.src=URL.createObjectURL(this.mediaSource),this.mediaSource.addEventListener("sourceopen",this.onMSEOpen.bind(this)),this.mediaSource.addEventListener("sourceclose",this.onMSEClose.bind(this)),this.mediaSource.addEventListener("webkitsourceopen",this.onMSEOpen.bind(this)),this.mediaSource.addEventListener("webkitsourceclose",this.onMSEClose.bind(this))}},{key:"feed",value:function(e){var t=!1,n=void 0,i=void 0,a=void 0,s={video:[],audio:[]};if(e&&this.remuxController){if(a=e.duration?parseInt(e.duration):0,e.video&&(n=h.extractNALu(e.video),n.length>0&&(s.video=this.getVideoFrames(n,a),t=!0)),e.audio&&(i=p.extractAAC(e.audio),i.length>0&&(s.audio=this.getAudioFrames(i,a),t=!0)),!t)return void r("Input object must have video and/or audio property. Make sure it is not empty and valid typed array");this.remuxController.remux(s)}}},{key:"getVideoFrames",value:function(e,t){var r=void 0,n=[],i=[],a=void 0,s=void 0,o=0,u=[],l=!0,f=!1,d=void 0;try{for(var h,y=e[Symbol.iterator]();!(l=(h=y.next()).done);l=!0)r=h.value,a=new c(r),n.push(a),a.type()!==c.IDR&&a.type()!==c.NDR||(i.push({units:n}),n=[],this.options.clearBuffer&&(a.type()===c.IDR&&u.push(this.frameCounter),this.frameCounter++))}catch(e){f=!0,d=e}finally{try{!l&&y.return&&y.return()}finally{if(f)throw d}}return t?(s=t/i.length|0,o=t-s*i.length):s=this.frameDuration,i.map(function(e){e.duration=o>0?s+1:s,0!==o&&o--}),this.options.clearBuffer&&(u=u.map(function(e){return e*s/1e3}),this.keyframeCache=this.keyframeCache.concat(u)),i}},{key:"getAudioFrames",value:function(e,t){var r=[],n=void 0,i=void 0,a=0,s=!0,o=!1,u=void 0;try{for(var l,f=e[Symbol.iterator]();!(s=(l=f.next()).done);s=!0)n=l.value,r.push({units:n})}catch(e){o=!0,u=e}finally{try{!s&&f.return&&f.return()}finally{if(o)throw u}}return t?(i=t/r.length|0,a=t-i*r.length):i=this.frameDuration,r.map(function(e){e.duration=a>0?i+1:i,0!==a&&a--}),r}},{key:"destroy",value:function(){if(this.stopInterval(),this.mediaSource){try{this.bufferControllers&&this.mediaSource.endOfStream()}catch(e){r("mediasource is not available to end "+e.message)}this.mediaSource=null}if(this.remuxController&&(this.remuxController.destroy(),this.remuxController=null),this.bufferControllers){for(var e in this.bufferControllers)this.bufferControllers[e].destroy();this.bufferControllers=null}this.node=!1,this.mseReady=!1,this.videoStarted=!1}},{key:"createBuffer",value:function(){if(this.mseReady&&this.remuxController&&this.remuxController.isReady()&&!this.bufferControllers){this.bufferControllers={};for(var e in this.remuxController.tracks){var t=this.remuxController.tracks[e];if(!n.isSupported(e+'/mp4; codecs="'+t.mp4track.codec+'"'))return r("Browser does not support codec"),!1;var i=this.mediaSource.addSourceBuffer(e+'/mp4; codecs="'+t.mp4track.codec+'"');this.bufferControllers[e]=new w(i,e),this.sourceBuffers[e]=i,this.bufferControllers[e].on("error",this.onBufferError.bind(this))}}}},{key:"startInterval",value:function(){var e=this;this.interval=setInterval(function(){e.bufferControllers&&(e.releaseBuffer(),e.clearBuffer())},this.options.flushingTime)}},{key:"stopInterval",value:function(){this.interval&&clearInterval(this.interval)}},{key:"releaseBuffer",value:function(){for(var e in this.bufferControllers)this.bufferControllers[e].doAppend()}},{key:"getSafeBufferClearLimit",value:function(e){for(var t="audio"===this.options.mode&&e||0,r=void 0,n=0;n<this.keyframeCache.length&&!(this.keyframeCache[n]>=e);n++)r=this.keyframeCache[n];return r&&(this.keyframeCache=this.keyframeCache.filter(function(e){return e<r&&(t=e),e>=r})),t}},{key:"clearBuffer",value:function(){if(this.options.clearBuffer&&Date.now()-this.lastCleaningTime>1e4){for(var e in this.bufferControllers){var t=this.getSafeBufferClearLimit(this.node.currentTime);this.bufferControllers[e].initCleanup(t)}this.lastCleaningTime=Date.now()}}},{key:"onBuffer",value:function(e){this.bufferControllers&&this.bufferControllers[e.type]&&this.bufferControllers[e.type].feed(e.payload)}},{key:"onMSEOpen",value:function(){this.mseReady=!0,"function"==typeof this.options.onReady&&(this.options.onReady(),this.options.onReady=null),this.createBuffer()}},{key:"onMSEClose",value:function(){this.mseReady=!1,this.videoStarted=!1}},{key:"onBufferError",value:function(e){if("QuotaExceeded"==e.name)return void this.bufferControllers[e.type].initCleanup(this.node.currentTime);if(this.mediaSource.sourceBuffers.length>0&&this.sourceBuffers[e.type]&&this.mediaSource.removeSourceBuffer(this.sourceBuffers[e.type]),0==this.mediaSource.sourceBuffers.length)try{this.mediaSource.endOfStream()}catch(e){r("mediasource is not available to end")}}}]),n}(v)});
